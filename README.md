# restful-dcp
REST API FOR DCP

build and run
```
docker build -t dcp-rest .
docker run -p 1234:1234 dcp-rest
```

---
API
# DCP HTTP API
The DCP HTTP API.

## Overview
This document describes the specification for the DCP HTTP API. This API is meant to serve as a replacement for, or compantion to, the `dcp-client`/`distributive` npm and pip package.

## Setup

Note, you will need access to a local version of DCP where you can modify your doorkeeper and add apps to it. The following examples will use my dcp for my bestia machine. Replace bestia with whatever fits your setup...

### Locksmith Setup
First generate a new OAuth app in your Doorkeeper with the name `locksmith`:

```yaml
Name: locksmith
Redirect URI: http://oauth.bestia.office.distributive.network/locksmith/
Confidential: <Checked>
Scopes: login
Proxy: <Blank>
Addr: <Blank>
Portal: <Unchecked>
```

I added the an entry for locksmith to my dcp-auth.conf nginx file for my oauth server located at `/etc/nginx/conf.d/dcp-auth.conf`:
```
server {
  listen 80;
  listen [::]:80;

  server_name oauth.bestia.office.distributive.network;

  location /reflector/ {
    proxy_pass http://localhost:3711/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
  }

  location /locksmith/ {
    proxy_pass http://localhost:3737/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
  }

  location / {
      proxy_pass http://localhost:3710/;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;
  }
}
```

Doorkeeper will generate a UIOD and Secret that you must copy into the `.env` file.

Next, run `locksmith` in the base of the directory with `node locksmith/auth.js`.

To use locksmith to generate api tokens, just navigate to wherever its set, for met its: `http://oauth.bestia.office.distributive.network/locksmith/`.

### API Setup

I like to add the following code to your `/etc/nginx/conf.d/dcp.conf`:

```
server {
  listen      80;   
  listen      [::]:80;
  server_name bestia.office.distributive.network;
  root        /var/www/bestia.office.distributive.network;
  access_log  /var/log/nginx/access.log combined buffer=512k flush=1m;
  error_log   /var/log/nginx/error.log warn;
  location / {
    proxy_pass http://localhost:5000;
  }

  location /reposter/ {
    proxy_pass http://localhost:5000/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
  }
    
  location /api/ {
    proxy_pass http://localhost:1234/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
  }
    
  location /example/ {
    proxy_pass http://localhost:3030/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
  }
}
```

But this doesn't matter so much, you can host your api at whatever address, localhost:1234 is fine...

With that you should be good to go.


## Authorization
Include this Bearer token generated by our oauth flow in your authorization headers. It can be generated at `http://oauth.bestia.office.distributive.network/locksmith/`

## Endpoints
### Submitting a Job
Path: `/job`
Method: `POST`
Request Body: JSON (refer to the spec.yaml swagger opanapi spec for reference)

Example:
```json
{
	"slices": [1,2,3,4,5,6,7,8,9,10],
	"work": {
		"language": "js",
		"function": "(datum) => { return datum * 2; }"
	},
	"account": {
		"address": "94E619279C5780fF20ECe07fAA719e3D66111A88"
	}
}
```

### Cancelling a Job
Path: `/job/[id]`
Method: `DELETE`
Request Body:
- `reason`: string

### Job Status
Path: `/job/[id]/status`
Method: `GET`

### Get bank accounts
Path: `/accounts`
Method: `GET`
Description: returns a list of all the user's bank accounts

### Getting results
Path: `/job/[id]/result`
Method: `GET`

## Things to add in the future

### Long polling for results
Path: `/job/[id]/result/wait`
Method: `GET`
Description: Makes a request doesn't respond until the results are in or the request expires / client disconnects. 
Responses:
- `200`
	- results

### Listening to the events for a job
Path: `/job/[id]/events/ws`
Method: `GET`
Description: Gets a websocket connection for job events presented as dcp protocol

Responses:
- `101`: Switching Protocols. Connection has been upgraded to a WebSocket
- `400`: Bad Request
- `403`: Forbidden
- `500`: Internal server error


